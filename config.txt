Glue code:

config/application.rb:

# This must come after ActionDispatch::Cookies to ensure the magic token cookie is correctly rendered in the redirect response
app.config.middleware.insert_after ActionDispatch::Cookies, MagicTokenRedirect

config/initializers/devise.rb

config.warden do |manager|
  manager.default_strategies(:scope => :user).unshift :magic_token_authentication
end

